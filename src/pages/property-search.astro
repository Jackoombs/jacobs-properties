---
import StandardLayout from "../layouts/StandardLayout.astro";
import PropertySearch from "../components/Form/PropertySearch";
import type { Property } from "../env";
import type { GoogleMapProps } from "@react-google-maps/api";

const res = await fetch("https://jacobs-server.onrender.com/properties");
const properties: Property[] = await res.json();
const propertiesWithLocation = await Promise.all(
  properties.map(async (property) => {
    const res2 = await fetch(
      `https://maps.googleapis.com/maps/api/geocode/json?address=${
        property.Address1
      }%20${property.Address2}&key=${import.meta.env.PUBLIC_GOOGLE_MAPS_KEY}`
    );
    const data = await res2.json();
    const location: GoogleMapProps["center"] = await data.results[0].geometry
      .location;
    return { ...property, Location: location };
  })
);
const res3 = await fetch(
  `https://maps.googleapis.com/maps/api/geocode/json?address=Basingstoke&key=${
    import.meta.env.PUBLIC_GOOGLE_MAPS_KEY
  }`
);
const data = await res3.json();
const center: GoogleMapProps["center"] = await data.results[0].geometry
  .location;
---

<StandardLayout title="Property Search">
  <PropertySearch
    center={center}
    properties={propertiesWithLocation}
    client:only
  />
</StandardLayout>
